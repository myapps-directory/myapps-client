<CPackWiXPatch xmlns:bal="http://schemas.microsoft.com/wix/BalExtension">


  <CPackWiXFragment Id="#PRODUCT" xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
       
    <SetProperty Id="ProgramFiles64Folder" Value="[LocalAppDataFolder]" Before="CostFinalize"><![CDATA[NOT Privileged]]></SetProperty>

    <Property Id="ALLUSERS" Secure="yes"/>
    <Property Id="MSIRESTARTMANAGERCONTROL">Disable</Property>
    <Property Id='NOTEPAD'>Notepad.exe</Property>
    <!--
    <Fragment>
    <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="LocalAppDataFolder">
                <Directory Id="INSTALLFOLDER" Name="OLA" />
            </Directory>
        </Directory>
    </Fragment>
    -->

    <Property Id="WINFSPDLL" Secure="yes">
      <DirectorySearch Id="PFFSearch" Path="[ProgramFilesFolder]">
        <DirectorySearch Id="WinFSPSearch" Path="WinFsp">
          <DirectorySearch Id="WinFSPBinSearch" Depth="0" Path="bin">
            <FileSearch Id="WinFPSSearch" Name="winfsp-x64.dll"/>
          </DirectorySearch>
        </DirectorySearch>
      </DirectorySearch>
    </Property>

    <Condition Message="This product requires WinFSP. Please install it from https://github.com/billziss-gh/winfsp/releases then try to install this product again.">
      WINFSPDLL
    </Condition>

    <Condition Message="All Users">
      NOT ALLUSERS
    </Condition>
    
    <UI>
        <Publish Dialog="ExitDialog" 
            Control="Finish" 
            Event="DoAction" 
            Value="LaunchReadMe">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed
        </Publish>
        <Publish Dialog="ExitDialog" 
            Control="Finish" 
            Event="DoAction" 
            Value="LaunchService">NOT Installed
        </Publish>
    </UI>

    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Show Readme.txt" />
    
    <CustomAction Id='LaunchReadMe' Property='NOTEPAD' ExeCommand='[ARPINSTALLLOCATION]readme.txt' Return='asyncNoWait' />
    
    <CustomAction Id='LaunchService' Directory='CM_DP_bin'
              Return="asyncNoWait"
              ExeCommand='[CM_DP_bin]ola_client_service.exe'/>
    
    <CustomAction Id="KillService" Directory='CM_DP_bin' Execute="deferred" ExeCommand="taskkill.exe /F /IM ola_client_service.exe" Return="asyncNoWait"/>

    <InstallExecuteSequence>
      <Custom Action='WixCloseApplications' Before='InstallValidate'>Installed</Custom>
      <Custom Action='KillService' Before='InstallFinalize'>Installed</Custom>
      <Custom Action='UninstallCleanup' After='ProcessComponents'>Installed</Custom>
    </InstallExecuteSequence>

    <!-- This works on notepad.exe - client_service should handle VM_CLOSE message: -->
    <util:CloseApplication Id="CloseApp" CloseMessage="yes" Target="ola_client_service.exe" RebootPrompt="no">
        Installed
    </util:CloseApplication>
    

    
    <CustomAction Id="UninstallCleanup" BinaryKey="ola_wix_custom_action_dll" DllEntry="UninstallCleanup"/>
    
  </CPackWiXFragment>

  <CPackWiXFragment Id="CM_CP_bin.ola_client_cli.exe">
    <Environment Id="PATH" Name="PATH" Value='[CM_DP_bin]' Permanent="yes" Part="last" Action="set" System="no" />
  </CPackWiXFragment>
</CPackWiXPatch>
